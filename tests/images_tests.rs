use ext4_fs::{
    extfs::{Ext4Reader, Ext4ReaderAction},
    structs::{Ext4Hash, FileInfo, FileType},
};
use std::{
    fs::File,
    io::{BufReader, Read, Seek},
    path::PathBuf,
};

fn walk_dir<T: std::io::Seek + std::io::Read>(
    info: &FileInfo,
    reader: &mut Ext4Reader<T>,
    cache: &mut Vec<String>,
    hash: bool,
    stat: bool,
    values: &mut Vec<FileInfo>,
) {
    for entry in &info.children {
        if stat {
            let info = reader.stat(entry.inode).unwrap();
            assert_ne!(info.inode, 0);
        }
        if entry.file_type == FileType::Directory
            && entry.name != "."
            && entry.name != ".."
            && entry.inode != 2
        {
            let info = reader.read_dir(entry.inode).unwrap();
            cache.push(info.name.clone());
            walk_dir(&info, reader, cache, hash, stat, values);
            cache.pop();
            continue;
        }
        if entry.file_type == FileType::Directory {
            continue;
        }

        if entry.file_type == FileType::File && hash {
            let hash_data = Ext4Hash {
                md5: true,
                sha1: false,
                sha256: false,
            };
            let hash_value = reader.hash(entry.inode, &hash_data).unwrap();
            assert!(!hash_value.md5.is_empty());
            // Check sparse files
            if format!("{}/{}", cache.join("/"), entry.name).contains("trailing_sparse") {
                assert_eq!(hash_value.md5, "e0b16e3a6c58c67928b5895797fccaa0");
            } else if format!("{}/{}", cache.join("/"), entry.name).contains("initial_sparse") {
                // assert_eq!(hash_value.md5, "c53dd591cf199ec5d692de2cbdb8559b");
            } else if format!("{}/{}", cache.join("/"), entry.name).contains("osquery_holes") {
                //assert_eq!(hash_value.md5, "ec131887a8a59260f64f1435f920d62a");
            }
        }

        if format!("{}/{}", cache.join("/"), entry.name).contains("osqueryd2")
            && entry.file_type == FileType::File
        {
            let mut file_reader = reader.reader(entry.inode).unwrap();
            let result = file_reader.seek(std::io::SeekFrom::Start(10)).unwrap();
            assert_eq!(result, 10);
            let mut buf = vec![0u8; 10];
            let bytes = file_reader.read(&mut buf).unwrap();
            assert_eq!(bytes, 10);
            assert_eq!(buf, [0, 0, 0, 0, 0, 0, 3, 0, 62, 0]);

            let result = file_reader.seek(std::io::SeekFrom::Current(77)).unwrap();
            // We are at offset 97 because:
            // Seek to offset 10 above
            // Read another 10 bytes
            // 20 + 77 == 97
            assert_eq!(result, 97);

            let mut buf = vec![0u8; 4097];
            let bytes = file_reader.read(&mut buf).unwrap();
            assert_eq!(bytes, 4097);
            assert_eq!(
                buf,
                [
                    2, 0, 0, 0, 0, 0, 0, 160, 2, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0,
                    0, 4, 0, 0, 0, 224, 2, 0, 0, 0, 0, 0, 0, 224, 2, 0, 0, 0, 0, 0, 0, 224, 2, 0,
                    0, 0, 0, 0, 0, 28, 0, 0, 0, 0, 0, 0, 0, 28, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,
                    0, 0, 0, 1, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 85, 241, 1, 0, 0, 0, 0, 12, 85, 241, 1, 0, 0, 0,
                    0, 0, 16, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 5, 0, 0, 0, 0, 96, 241, 1, 0, 0, 0, 0,
                    0, 96, 241, 1, 0, 0, 0, 0, 0, 96, 241, 1, 0, 0, 0, 0, 96, 182, 232, 2, 0, 0, 0,
                    0, 96, 182, 232, 2, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 6, 0, 0,
                    0, 0, 32, 218, 4, 0, 0, 0, 0, 0, 32, 218, 4, 0, 0, 0, 0, 0, 32, 218, 4, 0, 0,
                    0, 0, 56, 206, 69, 0, 0, 0, 0, 0, 56, 206, 69, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0,
                    0, 0, 0, 1, 0, 0, 0, 6, 0, 0, 0, 0, 240, 31, 5, 0, 0, 0, 0, 0, 240, 31, 5, 0,
                    0, 0, 0, 0, 240, 31, 5, 0, 0, 0, 0, 125, 71, 2, 0, 0, 0, 0, 0, 48, 122, 49, 0,
                    0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 4, 0, 0, 0, 0, 32, 218, 4, 0,
                    0, 0, 0, 0, 32, 218, 4, 0, 0, 0, 0, 0, 32, 218, 4, 0, 0, 0, 0, 112, 0, 0, 0, 0,
                    0, 0, 0, 248, 54, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 6, 0,
                    0, 0, 40, 79, 31, 5, 0, 0, 0, 0, 40, 79, 31, 5, 0, 0, 0, 0, 40, 79, 31, 5, 0,
                    0, 0, 0, 32, 2, 0, 0, 0, 0, 0, 0, 32, 2, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0,
                    0, 82, 229, 116, 100, 4, 0, 0, 0, 0, 32, 218, 4, 0, 0, 0, 0, 0, 32, 218, 4, 0,
                    0, 0, 0, 0, 32, 218, 4, 0, 0, 0, 0, 56, 206, 69, 0, 0, 0, 0, 0, 0, 208, 69, 0,
                    0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 80, 229, 116, 100, 4, 0, 0, 0, 216, 174,
                    50, 1, 0, 0, 0, 0, 216, 174, 50, 1, 0, 0, 0, 0, 216, 174, 50, 1, 0, 0, 0, 0,
                    156, 43, 25, 0, 0, 0, 0, 0, 156, 43, 25, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0,
                    81, 229, 116, 100, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 4, 0, 0, 0, 252, 2, 0, 0, 0, 0, 0, 0, 252, 2, 0,
                    0, 0, 0, 0, 0, 252, 2, 0, 0, 0, 0, 0, 0, 68, 0, 0, 0, 0, 0, 0, 0, 68, 0, 0, 0,
                    0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 47, 108, 105, 98, 54, 52, 47, 108, 100, 45,
                    108, 105, 110, 117, 120, 45, 120, 56, 54, 45, 54, 52, 46, 115, 111, 46, 50, 0,
                    4, 0, 0, 0, 16, 0, 0, 0, 1, 0, 0, 0, 71, 78, 85, 0, 0, 0, 0, 0, 4, 0, 0, 0, 7,
                    0, 0, 0, 10, 0, 0, 0, 4, 0, 0, 0, 20, 0, 0, 0, 3, 0, 0, 0, 71, 78, 85, 0, 203,
                    157, 139, 253, 1, 22, 6, 98, 122, 171, 104, 196, 6, 49, 76, 60, 164, 84, 238,
                    161, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                    0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 0, 0,
                    0, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 34, 0, 0, 0,
                    34, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 49, 0, 0, 0, 18,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 54, 0, 0, 0, 18, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 61, 0, 0, 0, 18, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 68, 0, 0, 0, 17, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 76, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 85, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 93, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 99, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 106, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 113, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 121, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 141, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 151, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    158, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 169,
                    0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 175, 0,
                    0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 0, 0,
                    0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 200, 0, 0, 0,
                    17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 207, 0, 0, 0, 18,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 214, 0, 0, 0, 18, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 226, 0, 0, 0, 18, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 233, 0, 0, 0, 18, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 240, 0, 0, 0, 18, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 245, 0, 0, 0, 18, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 252, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 34, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 40, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 46, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 52, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    57, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64,
                    1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 70, 1, 0,
                    0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 82, 1, 0, 0,
                    18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 89, 1, 0, 0, 18,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 97, 1, 0, 0, 18, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 104, 1, 0, 0, 18, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 114, 1, 0, 0, 18, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 121, 1, 0, 0, 18, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 133, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 140, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 149, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 157, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 163, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 170, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 178, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 186, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 193, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 213, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 227, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 234, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 246, 1, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 3, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 20,
                    2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 26, 2, 0,
                    0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 33, 2, 0, 0,
                    18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 40, 2, 0, 0, 17,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 47, 2, 0, 0, 18, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 63, 2, 0, 0, 18, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 70, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 92, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 114, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 136, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 143, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 158, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 177, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 198, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 218, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 237, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 250, 2, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 14, 3, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    23, 3, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 31,
                    3, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 40, 3, 0,
                    0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 48, 3, 0, 0,
                    18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 55, 3, 0, 0, 18,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 78, 3, 0, 0, 18, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 99, 3, 0, 0, 18, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 117, 3, 0, 0, 18, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 137, 3, 0, 0, 18, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 155, 3, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 180, 3, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 202, 3, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 228, 3, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 250, 3, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 13, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 24, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 32, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 42, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    50, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 55,
                    4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 60, 4, 0,
                    0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 75, 4, 0, 0,
                    18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 80, 4, 0, 0, 18,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 85, 4, 0, 0, 18, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 90, 4, 0, 0, 18, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 95, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 99, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 104, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 110, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 114, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 120, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 124, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 128, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 133, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 137, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 142, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 168, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 191, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    217, 4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 225,
                    4, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 233, 4,
                    0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 238, 4, 0,
                    0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 253, 4, 0, 0,
                    18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 5, 0, 0, 18, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 5, 0, 0, 18, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 27, 5, 0, 0, 18, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 50, 5, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 5, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 67, 5, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 73, 5, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 79, 5, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 86, 5, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 93, 5, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    100, 5, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 107,
                    5, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 112, 5,
                    0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 119, 5, 0,
                    0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 124, 5, 0, 0,
                    18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 130, 5, 0, 0, 18,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 148, 5, 0, 0, 18, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 161, 5, 0, 0, 18, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 178, 5, 0, 0, 18, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 186, 5, 0, 0, 18, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 5
                ]
            );

            // reset position
            let result = file_reader.seek(std::io::SeekFrom::Start(0)).unwrap();
            assert_eq!(result, 0);
            // jump to the last 20 bytes
            let result = file_reader.seek(std::io::SeekFrom::End(-20)).unwrap();
            assert_eq!(result, 274310844);
            let mut buf = vec![0u8; 20];
            let bytes = file_reader.read(&mut buf).unwrap();
            assert_eq!(bytes, 20);
            assert_eq!(
                buf,
                [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            );

            // reset position. We went to the end of the file
            // Validate we can go back to beginning and read again if we want too
            let result = file_reader.seek(std::io::SeekFrom::Start(22)).unwrap();
            assert_eq!(result, 22);
            let mut buf = vec![0u8; 81];
            let bytes = file_reader.read(&mut buf).unwrap();
            assert_eq!(bytes, 81);
            assert_eq!(
                buf,
                [
                    0, 0, 0, 96, 241, 1, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 16, 156, 89, 16, 0,
                    0, 0, 0, 0, 0, 0, 0, 64, 0, 56, 0, 12, 0, 64, 0, 43, 0, 41, 0, 6, 0, 0, 0, 4,
                    0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0,
                    0, 0, 160, 2, 0, 0, 0, 0, 0
                ]
            );
        }
    }
}

#[test]
fn test_read_root_directory() {
    let mut test_location = PathBuf::from(env!("CARGO_MANIFEST_DIR"));
    test_location.push("tests/images/test.img");
    let reader = File::open(test_location.to_str().unwrap()).unwrap();
    let buf = BufReader::new(reader);
    let mut ext4_reader = Ext4Reader::new(buf, 4096).unwrap();
    let dir = ext4_reader.root().unwrap();

    assert_eq!(dir.created, 1759689014000000000);
    assert_eq!(dir.changed, 1759713496631583423);
    assert_eq!(dir.children.len(), 6);
}

#[test]
fn test_walk_entire_filesystem() {
    let mut test_location = PathBuf::from(env!("CARGO_MANIFEST_DIR"));
    test_location.push("tests/images/test.img");
    let reader = File::open(test_location.to_str().unwrap()).unwrap();
    let buf = BufReader::new(reader);
    let mut ext4_reader = Ext4Reader::new(buf, 4096).unwrap();
    let root = ext4_reader.root().unwrap();

    let mut cache = Vec::new();
    cache.push(String::new());

    let mut values = Vec::new();
    walk_dir(
        &root,
        &mut ext4_reader,
        &mut cache,
        false,
        false,
        &mut values,
    );
}

#[test]
fn test_hash_helloworld() {
    let mut test_location = PathBuf::from(env!("CARGO_MANIFEST_DIR"));
    test_location.push("tests/images/test.img");
    let reader = File::open(test_location.to_str().unwrap()).unwrap();
    let buf = BufReader::new(reader);
    let mut ext4_reader = Ext4Reader::new(buf, 4096).unwrap();

    let mut cache = Vec::new();
    cache.push(String::new());

    let hash_data = Ext4Hash {
        md5: true,
        sha1: false,
        sha256: false,
    };
    let hash_value = ext4_reader.hash(14, &hash_data).unwrap();
    assert_eq!(hash_value.md5, "c897d1410af8f2c74fba11b1db511e9e");
}

#[test]
fn test_hash_every_file() {
    let mut test_location = PathBuf::from(env!("CARGO_MANIFEST_DIR"));
    test_location.push("tests/images/test.img");
    let reader = File::open(test_location.to_str().unwrap()).unwrap();
    let buf = BufReader::new(reader);
    let mut ext4_reader = Ext4Reader::new(buf, 4096).unwrap();
    let root = ext4_reader.root().unwrap();

    let mut cache = Vec::new();
    cache.push(String::new());

    let mut values = Vec::new();
    walk_dir(
        &root,
        &mut ext4_reader,
        &mut cache,
        true,
        false,
        &mut values,
    );
}

#[test]
fn test_stat_everything() {
    let mut test_location = PathBuf::from(env!("CARGO_MANIFEST_DIR"));
    test_location.push("tests/images/test.img");
    let reader = File::open(test_location.to_str().unwrap()).unwrap();
    let buf = BufReader::new(reader);
    let mut ext4_reader = Ext4Reader::new(buf, 4096).unwrap();
    let root = ext4_reader.root().unwrap();

    let mut cache = Vec::new();
    cache.push(String::new());

    let mut values = Vec::new();
    walk_dir(
        &root,
        &mut ext4_reader,
        &mut cache,
        false,
        true,
        &mut values,
    );
}

#[test]
fn test_ext4_minefield() {
    let mut test_location = PathBuf::from(env!("CARGO_MANIFEST_DIR"));
    test_location.push("tests/keramics/ext4.raw");
    let reader = File::open(test_location.to_str().unwrap()).unwrap();
    let buf = BufReader::new(reader);

    // The blocksize for the example is actually 1024. The blocksize should self correct once the superblock is parsed
    let mut ext4_reader = Ext4Reader::new(buf, 4096).unwrap();
    let root = ext4_reader.root().unwrap();

    let mut cache = Vec::new();
    cache.push(String::new());
    let mut values = Vec::new();
    walk_dir(&root, &mut ext4_reader, &mut cache, true, true, &mut values);
}
